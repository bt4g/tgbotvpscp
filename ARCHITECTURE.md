# üìò –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞: VPS Manager Telegram Bot

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

**VPS Manager Telegram Bot** ‚Äî —ç—Ç–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ. –ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω **–ê–≥–µ–Ω—Ç-–ö–ª–∏–µ–Ω—Ç**, –≥–¥–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–æ—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Ç—å—é —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API.

### üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** ‚Äî –∫–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–æ–¥—É–ª–µ
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** ‚Äî –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ asyncio –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äî –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ (WAF, Rate Limiting, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –Ω–æ–¥
5. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** ‚Äî —Å–∏—Å—Ç–µ–º–∞ Watchdog –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### üîπ –ö–æ—Ä–Ω–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å

```
/opt/tg-bot/
‚îú‚îÄ‚îÄ bot.py                    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ watchdog.py              # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è, –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
‚îú‚îÄ‚îÄ migrate.py               # –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ manage.py                # CLI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º
‚îú‚îÄ‚îÄ .env                     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–µ–∫—Ä–µ—Ç—ã, —Ç–æ–∫–µ–Ω—ã)
‚îú‚îÄ‚îÄ requirements.txt         # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ docker-compose.yml       # Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Dockerfile               # –û–±—Ä–∞–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
‚îî‚îÄ‚îÄ deploy.sh               # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫
```

#### **bot.py** ‚Äî –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Aiogram Bot –∏ Dispatcher
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ SQLite –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (Tortoise ORM)
- –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (Aiohttp) –Ω–∞ –ø–æ—Ä—Ç—É 8080
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –∏ middleware
- –û–±—Ä–∞–±–æ—Ç–∫–∞ lifecycle events (startup/shutdown)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sentry –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** Aiogram 3.x, AsyncIO, Tortoise ORM

---

#### **watchdog.py** ‚Äî –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–æ—Ç–∞ (health check)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–±–æ–µ
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ (start/stop/crash)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π —Å–∏—Å—Ç–µ–º—ã
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

**–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã:**
- Systemd service (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- Docker container (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è)

---

### üîπ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `core/` ‚Äî –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã

```
core/
‚îú‚îÄ‚îÄ config.py               # –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ auth.py                 # –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ server.py               # Web-—Å–µ—Ä–≤–µ—Ä –∏ API
‚îú‚îÄ‚îÄ i18n.py                 # –ò–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ keyboards.py            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ messaging.py            # –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ middlewares.py          # Anti-spam, —Ñ–∏–ª—å—Ç—Ä—ã
‚îú‚îÄ‚îÄ utils.py                # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ nodes_db.py             # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–æ–¥ (SQLite)
‚îú‚îÄ‚îÄ models.py               # ORM –º–æ–¥–µ–ª–∏ (Tortoise)
‚îú‚îÄ‚îÄ shared_state.py         # –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
‚îú‚îÄ‚îÄ static/                 # CSS, JS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.css
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.css
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ style.css
‚îÇ   ‚îî‚îÄ‚îÄ js/
‚îÇ       ‚îú‚îÄ‚îÄ common.js       # –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ       ‚îú‚îÄ‚îÄ dashboard.js    # –õ–æ–≥–∏–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞
‚îÇ       ‚îú‚îÄ‚îÄ login.js        # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ settings.js     # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ       ‚îî‚îÄ‚îÄ theme_init.js   # –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
‚îî‚îÄ‚îÄ templates/              # HTML —à–∞–±–ª–æ–Ω—ã
    ‚îú‚îÄ‚îÄ dashboard.html
    ‚îú‚îÄ‚îÄ login.html
    ‚îú‚îÄ‚îÄ reset_password.html
    ‚îî‚îÄ‚îÄ settings.html
```

---

#### **config.py** ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

**–ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `TOKEN` ‚Äî –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
- `ADMIN_USER_ID` ‚Äî ID –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- `WEB_SERVER_HOST/PORT` ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
- `DEPLOY_MODE` ‚Äî –†–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (root/secure)
- `DEFAULT_LANGUAGE` ‚Äî –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- `ENABLE_WEB_UI` ‚Äî –í–∫–ª—é—á–µ–Ω–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –ü—É—Ç–∏ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º (–ª–æ–≥–∏, –∫–æ–Ω—Ñ–∏–≥, –±—ç–∫–∞–ø—ã)

**–§—É–Ω–∫—Ü–∏–∏:**
- `load_encrypted_json()` ‚Äî –ß—Ç–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤
- `save_encrypted_json()` ‚Äî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å Fernet —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
- `save_system_config()` ‚Äî –ó–∞–ø–∏—Å—å —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
- `save_keyboard_config()` ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

---

#### **auth.py** ‚Äî –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

**–ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–æ–ª–µ–π:**
1. **Root/Owner** (ADMIN_USER_ID) ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø, –≤–∫–ª—é—á–∞—è –æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
2. **Admins** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–∞–º–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫
3. **Users** ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–§—É–Ω–∫—Ü–∏–∏:**
- `is_root_admin()` ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
- `is_admin()` ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤
- `check_user_access()` ‚Äî –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏–∏
- `load_users()` ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `save_users()` ‚Äî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º (Fernet)

**–•—Ä–∞–Ω–∏–ª–∏—â–µ:** `/opt/tg-bot/config/users.json` (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω)

---

#### **server.py** ‚Äî –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∏ API
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** REST API, Dashboard, SSE —Å—Ç—Ä–∏–º—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:**

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- `POST /api/login` ‚Äî –í—Ö–æ–¥ –≤ –≤–µ–±-–ø–∞–Ω–µ–ª—å
- `POST /api/logout` ‚Äî –í—ã—Ö–æ–¥, —É–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
- `POST /api/request_reset` ‚Äî –ó–∞–ø—Ä–æ—Å —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
- `POST /api/reset_password` ‚Äî –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É

**Dashboard:**
- `GET /` ‚Äî –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∞—à–±–æ—Ä–¥–∞
- `GET /api/dashboard_data` ‚Äî –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
- `POST /api/reset_traffic` ‚Äî –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞

**Real-time Events (SSE):**
- `GET /api/events` ‚Äî Server-Sent Events –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `GET /api/events/services` ‚Äî SSE –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

**Nodes Management:**
- `GET /api/nodes` ‚Äî –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–æ–¥
- `POST /api/nodes/register` ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –Ω–æ–¥—ã
- `POST /api/nodes/:token/metrics` ‚Äî –ü—Ä–∏–µ–º –º–µ—Ç—Ä–∏–∫ –æ—Ç –Ω–æ–¥—ã
- `POST /api/nodes/:id/delete` ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–¥—ã

**System:**
- `GET /api/logs/:type` ‚Äî –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤
- `POST /api/system_config` ‚Äî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `POST /api/keyboard_config` ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- `POST /api/alerts_config` ‚Äî –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤

**Security Features:**
- **WAF** ‚Äî Web Application Firewall (SQL Injection, XSS, Path Traversal)
- **Rate Limiting** ‚Äî 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç–∞ –Ω–∞ IP
- **Brute-force Protection** ‚Äî –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- **CSRF Tokens** ‚Äî –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **Session Management** ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ —Å–µ—Å—Å–∏–∏
- **Audit Logging** ‚Äî –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `logs/audit/audit.log`

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** Aiohttp, Argon2 (—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π), Jinja2 (—à–∞–±–ª–æ–Ω—ã)
---

#### **i18n.py** ‚Äî –°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏:**
- –†—É—Å—Å–∫–∏–π (ru) ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π
- English (en) ‚Äî –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤:**
```python
STRINGS = {
    "key_name": {
        "ru": "–†—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç",
        "en": "English text"
    }
}
```

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `get_text(key, lang)` ‚Äî –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞
- `get_user_lang(user_id)` ‚Äî –Ø–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `set_user_lang(user_id, lang)` ‚Äî –°–º–µ–Ω–∞ —è–∑—ã–∫–∞
- `I18nFilter` ‚Äî Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞

**–•—Ä–∞–Ω–∏–ª–∏—â–µ:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞ –≤ `config/users.json`

---

#### **keyboards.py** ‚Äî –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä UI
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä

**–¢–∏–ø—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä:**
1. **Reply Keyboard** ‚Äî –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
2. **Inline Keyboard** ‚Äî Callback –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

**–§—É–Ω–∫—Ü–∏–∏:**
- `get_main_reply_keyboard(user_id)` ‚Äî –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤
- `get_subcategory_keyboard(category, user_id)` ‚Äî –ü–æ–¥–º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- `get_manage_users_keyboard()` ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- `get_keyboard_settings_inline()` ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

**–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è/–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç:
- –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Root/Admin/User)
- –†–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (DEPLOY_MODE: root/secure)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ `config/keyboard_config.json`

---

#### **messaging.py** ‚Äî –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∞–ª–µ—Ä—Ç–æ–≤

**–§—É–Ω–∫—Ü–∏–∏:**
- `send_alert()` ‚Äî –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ markdown
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–µ–±-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
- `delete_previous_message()` ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `send_support_message()` ‚Äî –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫—É

**–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- ‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–æ–≤ —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU/RAM/Disk)
- üîí SSH-–≤—Ö–æ–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- üõ°Ô∏è –ë–∞–Ω IP —á–µ—Ä–µ–∑ Fail2Ban
- üì° –î–∞—É–Ω—Ç–∞–π–º –Ω–æ–¥—ã (–Ω–æ–¥–∞ –æ—Ñ–ª–∞–π–Ω)
- üöÄ –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (—Å—Ç–∞—Ä—Ç/—Ä–µ—Å—Ç–∞—Ä—Ç –±–æ—Ç–∞)

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- Telegram API –¥–ª—è –±–æ—Ç–æ–≤
- –í–µ–±-–ø–∞–Ω–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —á–µ—Ä–µ–∑ SSE (`/api/events`)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `logs/bot/bot.log`

---

#### **middlewares.py** ‚Äî Middleware —Å–ª–æ–π
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ –≤—ã–∑–æ–≤–∞ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ middleware:**

**SpamThrottleMiddleware:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–ª—É–¥–∞ (–º–∞–∫—Å. 1 –∑–∞–ø—Ä–æ—Å –≤ —Å–µ–∫—É–Ω–¥—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

---

#### **utils.py** ‚Äî –£—Ç–∏–ª–∏—Ç—ã –∏ —Ö–µ–ª–ø–µ—Ä—ã
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—â–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:**

**–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- `format_bytes(bytes)` ‚Äî –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –±–∞–π—Ç –≤ KB/MB/GB
- `format_uptime(seconds)` ‚Äî –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–µ–∫—É–Ω–¥ –≤ —á–∏—Ç–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç
- `get_country_flag(ip)` ‚Äî –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ —Å—Ç—Ä–∞–Ω—ã –ø–æ IP

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- `encrypt_for_web(data)` ‚Äî XOR + Base64 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤–µ–±-–∫–ª–∏–µ–Ω—Ç–∞
- `decrypt_for_web(data)` ‚Äî –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- `log_audit_event()` ‚Äî –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (GDPR compliant)
- `mask_sensitive_data()` ‚Äî –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ IP, —Ç–æ–∫–µ–Ω–æ–≤, –ø–∞—Ä–æ–ª–µ–π

**–°–∏—Å—Ç–µ–º–∞:**
- `get_host_path()` ‚Äî –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è Docker
- `get_app_version()` ‚Äî –í–µ—Ä—Å–∏—è –∏–∑ CHANGELOG
- `get_server_timezone_label()` ‚Äî –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —Å–µ—Ä–≤–µ—Ä–∞
- `generate_favicons()` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫ –¥–ª—è PWA

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤:**
- `load_services_config()` ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ `config/services.json` (Fernet)
- `save_services_config()` ‚Äî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

---

#### **nodes_db.py** ‚Äî –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–æ–¥
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ —Å–µ—Ä–≤–µ—Ä–∞–º–∏

**ORM:** Tortoise ORM + SQLite (`config/nodes.db`)

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `init_nodes_db()` ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã
- `add_node()` ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –Ω–æ–¥—ã
- `get_node_by_token()` ‚Äî –ü–æ–∏—Å–∫ –ø–æ —Ç–æ–∫–µ–Ω—É
- `update_node_metrics()` ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
- `get_all_nodes()` ‚Äî –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
- `delete_node()` ‚Äî –£–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–¥—ã

**–ú–æ–¥–µ–ª—å Node:**
```python
class Node:
    id: int
    token: str              # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    name: str               # –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è
    ip: str                 # IP –∞–¥—Ä–µ—Å –Ω–æ–¥—ã
    last_seen: datetime     # –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    cpu_percent: float      # –ó–∞–≥—Ä—É–∑–∫–∞ CPU
    ram_percent: float      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM
    disk_percent: float     # –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –¥–∏—Å–∫–∞
    uptime: int             # –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã (—Å–µ–∫—É–Ω–¥—ã)
```

---

#### **models.py** ‚Äî ORM –º–æ–¥–µ–ª–∏
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

**–ú–æ–¥–µ–ª–∏:**
- `User` ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ (Telegram ID, —Ä–æ–ª—å, —è–∑—ã–∫)
- `Node` ‚Äî –£–¥–∞–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã
- `Alert` ‚Äî –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `TrafficLog` ‚Äî –õ–æ–≥–∏ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞

**–ú–∏–≥—Ä–∞—Ü–∏–∏:** –£–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Aerich (`aerich.ini`)

---

#### **shared_state.py** ‚Äî –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
- `ALLOWED_USERS: dict` ‚Äî –ö—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `AUTH_TOKENS: dict` ‚Äî –¢–æ–∫–µ–Ω—ã –Ω–æ–¥
- `NODE_TRAFFIC_MONITORS: dict` ‚Äî –ê–∫—Ç–∏–≤–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä—ã —Ç—Ä–∞—Ñ–∏–∫–∞
- `ALERTS_CONFIG: dict` ‚Äî –ü–æ—Ä–æ–≥–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `AGENT_HISTORY: deque` ‚Äî –ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫ –∞–≥–µ–Ω—Ç–∞ (–∫–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä)
- `WEB_NOTIFICATIONS: deque` ‚Äî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –≤–µ–±-–ø–∞–Ω–µ–ª–∏
- `WEB_USER_LAST_READ: dict` ‚Äî –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `deque` –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ `gc.collect()`

---

### üîπ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `modules/` ‚Äî –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏

```
modules/
‚îú‚îÄ‚îÄ selftest.py             # –°–≤–æ–¥–∫–∞ –æ —Å–µ—Ä–≤–µ—Ä–µ (CPU/RAM/Disk/IP)
‚îú‚îÄ‚îÄ traffic.py              # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
‚îú‚îÄ‚îÄ uptime.py               # –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
‚îú‚îÄ‚îÄ top.py                  # –¢–æ–ø-10 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ CPU
‚îú‚îÄ‚îÄ speedtest.py            # –¢–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ (iperf3)
‚îú‚îÄ‚îÄ notifications.py        # –§–æ–Ω–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∞–ª–µ—Ä—Ç—ã
‚îú‚îÄ‚îÄ users.py                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îú‚îÄ‚îÄ nodes.py                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–∞–º–∏
‚îú‚îÄ‚îÄ services.py             # –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ vless.py                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è VLESS —Å—Å—ã–ª–æ–∫
‚îú‚îÄ‚îÄ xray.py                 # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Xray Core
‚îú‚îÄ‚îÄ sshlog.py               # –õ–æ–≥–∏ SSH –≤—Ö–æ–¥–æ–≤
‚îú‚îÄ‚îÄ fail2ban.py             # –õ–æ–≥–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IP
‚îú‚îÄ‚îÄ logs.py                 # –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ (journalctl)
‚îú‚îÄ‚îÄ update.py               # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞ –∏ —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ reboot.py               # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ restart.py              # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ optimize.py             # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã
‚îî‚îÄ‚îÄ backups.py              # –ë—ç–∫–∞–ø—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

#### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª—è

–ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:

```python
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
def get_button() -> KeyboardButton:
    """–ö–Ω–æ–ø–∫–∞ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    
def register_handlers(dp: Dispatcher):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
def has_subcategory() -> bool:
    """–ï—Å—Ç—å –ª–∏ –ø–æ–¥–º–µ–Ω—é"""
    
def get_subcategory() -> str:
    """–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (monitoring/management/security/tools)"""
```

---

#### **notifications.py** ‚Äî –°–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–æ–≤
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –§–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- CPU > 80% (–ø–æ—Ä–æ–≥ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π)
- RAM > 90%
- Disk > 85%
- –î–∞—É–Ω—Ç–∞–π–º –Ω–æ–¥—ã > 60 —Å–µ–∫—É–Ω–¥

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ `asyncio.create_task(check_alerts_loop())`
- –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏: 30 —Å–µ–∫—É–Ω–¥
- –î–µ–±–∞—É–Ω—Å: –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** –í–µ–±-–ø–∞–Ω–µ–ª—å Settings ‚Üí Alerts Config

---

#### **services.py** ‚Äî –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (ssh, docker, nginx, mysql, etc.)
- Start/Stop/Restart —Å–µ—Ä–≤–∏—Å–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ SSE (`/api/events/services`)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö: XOR + Base64 –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
- –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (JavaScript)
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: `config/services.json` (Fernet)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```
Backend (server.py)
  ‚Üì SSE Stream (5 sec interval)
  ‚Üì encrypt_for_web(data)
Frontend (dashboard.js)
  ‚Üì EventSource API
  ‚Üì decrypt_for_web(data)
  ‚Üì Update UI
```

**–§—É–Ω–∫—Ü–∏–∏:**
- `get_all_services_status()` ‚Äî –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- `perform_service_action(service, action)` ‚Äî –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
- `add_managed_service()` ‚Äî –î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- `remove_managed_service()` ‚Äî –£–¥–∞–ª–∏—Ç—å –∏–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

#### **nodes.py** ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–¥–∞–º–∏
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ú—É–ª—å—Ç–∏-—Å–µ—Ä–≤–µ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–§—É–Ω–∫—Ü–∏–∏:**
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –Ω–æ–¥—ã (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞)
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –Ω–æ–¥
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏
- –£–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–¥—ã
- –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (CPU, RAM, uptime)

**–ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
1. Root –∞–¥–º–∏–Ω: "–ù–æ–¥—ã" ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—É"
2. –í–≤–æ–¥–∏—Ç –∏–º—è ‚Üí –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω
3. –ù–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ: 
   ```bash
   curl -O deploy_en.sh && bash deploy_en.sh
   # –í—ã–±—Ä–∞—Ç—å "Install NODE (Client)"
   # –í–≤–µ—Å—Ç–∏ URL –∞–≥–µ–Ω—Ç–∞ –∏ —Ç–æ–∫–µ–Ω
   ```
4. –ù–æ–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ

**–ê–≥–µ–Ω—Ç –Ω–æ–¥—ã:** `node/node.py` ‚Äî –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π HTTP —Å–µ—Ä–≤–µ—Ä, –æ—Ç–ø—Ä–∞–≤–ª—è—é—â–∏–π –º–µ—Ç—Ä–∏–∫–∏

---

### üîπ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `node/` ‚Äî –ö–ª–∏–µ–Ω—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤

```
node/
‚îî‚îÄ‚îÄ node.py                 # –ê–≥–µ–Ω—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ—Ç—Ä–∏–∫
```

#### **node.py** ‚Äî –ê–≥–µ–Ω—Ç –Ω–æ–¥—ã
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–ª–∏–µ–Ω—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö VPS

**–§—É–Ω–∫—Ü–∏–∏:**
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ —Å–∏—Å—Ç–µ–º—ã (CPU, RAM, Disk, uptime)
- –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (`POST /api/nodes/{token}/metrics`)
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (–ø–æ –∑–∞–ø—Ä–æ—Å—É –æ—Ç –∞–≥–µ–Ω—Ç–∞)
- SSH-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- Python 3.10+
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: requests, psutil
- –û—Ç–∫—Ä—ã—Ç—ã–π –ø–æ—Ä—Ç –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ (8080)

**Deployment:**
```bash
cd /opt && git clone <repo> tg-node
cd tg-node/node
python3 node.py --agent-url http://MAIN_SERVER:8080 --token NODE_TOKEN
```

**Systemd –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
```ini
[Unit]
Description=TG Node Agent
[Service]
ExecStart=/usr/bin/python3 /opt/tg-node/node/node.py ...
Restart=always
[Install]
WantedBy=multi-user.target
```

---

## üîê –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –£—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã

#### 1Ô∏è‚É£ Telegram Bot Security
- **Whitelist** ‚Äî –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ Telegram ID
- **Role-based Access Control** ‚Äî Root/Admin/User
- **Anti-spam middleware** ‚Äî Throttling 1 req/sec per user

#### 2Ô∏è‚É£ Web Panel Security
- **Argon2** ‚Äî Password hashing (OWASP recommended)
- **Server-side sessions** ‚Äî Secure cookie with HTTPS
- **CSRF Protection** ‚Äî –¢–æ–∫–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö POST –∑–∞–ø—Ä–æ—Å–æ–≤
- **Brute-force Protection** ‚Äî 5 –ø–æ–ø—ã—Ç–æ–∫ ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 5 –º–∏–Ω—É—Ç
- **Rate Limiting** ‚Äî 100 API requests/min per IP

#### 3Ô∏è‚É£ WAF (Web Application Firewall)
–ü–∞—Ç—Ç–µ—Ä–Ω—ã –∞—Ç–∞–∫:
- SQL Injection (`UNION SELECT`, `OR 1=1`)
- XSS (`<script>`, `javascript:`)
- Path Traversal (`../`, `%2e%2e`)
- Command Injection (`;`, `|`, `` ` ``)
- LDAP Injection (`()`, `|`)

#### 4Ô∏è‚É£ Data Encryption
- **Fernet** ‚Äî –°–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤
  - `users.json`, `services.json`, `alerts_config.json`
- **XOR + Base64** ‚Äî –õ–µ–≥–∫–æ–≤–µ—Å–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤–µ–±-–∫–ª–∏–µ–Ω—Ç–∞
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è SSE events, services data

#### 5Ô∏è‚É£ Audit Logging
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `logs/audit/audit.log`

**–ó–∞–ø–∏—Å—ã–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è:**
- Login attempts (success/fail)
- Password resets
- User additions/deletions
- Configuration changes
- Suspicious activity (WAF triggers)

**–§–æ—Ä–º–∞—Ç:**
```json
{
  "timestamp": "2026-01-27T12:00:00Z",
  "event_type": "LOGIN_SUCCESS",
  "ip": "203.0.113.X",
  "user": "admin",
  "details": {...}
}
```

**Privacy:**
- IP –∞–¥—Ä–µ—Å–∞ –º–∞—Å–∫–∏—Ä—É—é—Ç—Å—è (203.0.113.XXX)
- –¢–æ–∫–µ–Ω—ã —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è (abc123...)
- GDPR compliant

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### Startup Sequence

```
1. Load .env configuration
2. Initialize logging system
3. Connect to SQLite database (Tortoise ORM)
4. Load encrypted configs (users, alerts, services)
5. Initialize Telegram Bot + Dispatcher
6. Register all modules & handlers
7. Start Aiohttp web server (port 8080)
8. Launch background tasks:
   - check_alerts_loop()
   - agent_metrics_collector()
   - SSE event broadcaster
9. Send startup notification to admin
```

### Shutdown Sequence

```
1. Signal received (SIGTERM/SIGINT)
2. Stop accepting new requests
3. Cancel background tasks
4. Save in-memory state to disk
5. Close database connections
6. Stop web server
7. Send shutdown notification
8. Exit gracefully (exit code 0)
```

### Watchdog Flow

```
while True:
    if bot_process_alive():
        send_heartbeat()
    else:
        log_crash_event()
        send_alert("Bot crashed, restarting...")
        restart_bot_process()
    sleep(30)
```

---

## üìä –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### Metrics Collection Flow

```
Remote Node (node.py)
    ‚Üì (every 60 sec)
POST /api/nodes/{token}/metrics
    {
        "cpu": 45.2,
        "ram": 72.1,
        "disk": 38.5,
        "uptime": 864000
    }
    ‚Üì
Agent Server (server.py)
    ‚Üì
Update nodes_db (SQLite)
    ‚Üì
Store in AGENT_HISTORY (deque)
    ‚Üì
Check thresholds ‚Üí Trigger alert if needed
    ‚Üì
Broadcast via SSE ‚Üí Web Dashboard updates
```

### User Interaction Flow

```
User (Telegram)
    ‚Üì
Send command "/start"
    ‚Üì
SpamThrottleMiddleware
    ‚Üì
Auth check (is_admin/is_root)
    ‚Üì
I18n translation
    ‚Üì
Module handler (e.g., selftest.py)
    ‚Üì
Execute system command (if root mode)
    ‚Üì
Format response with markdown
    ‚Üì
Send message + inline keyboard
    ‚Üì
Store message_id for deletion
```

### SSE Event Flow

```
Backend Event (e.g., node metric update)
    ‚Üì
Encrypt data (encrypt_for_web)
    ‚Üì
Push to WEB_NOTIFICATIONS deque
    ‚Üì
SSE endpoint /api/events checks queue
    ‚Üì
Send as "data: {encrypted_json}\n\n"
    ‚Üì
Frontend EventSource receives
    ‚Üì
Decrypt (decrypt_for_web)
    ‚Üì
Update DOM dynamically
```

---

## üé® –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- **Tailwind CSS** ‚Äî Utility-first CSS framework
- **Vanilla JavaScript** ‚Äî No frameworks, pure ES6+
- **Server-Sent Events** ‚Äî Real-time updates without WebSocket
- **Chart.js** ‚Äî –ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- **PWA** ‚Äî Progressive Web App —Å –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–º

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

#### **dashboard.js**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –õ–æ–≥–∏–∫–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `initServicesSSE()` ‚Äî –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SSE –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
- `loadServices()` ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
- `updateDashboard()` ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
- `openServiceInfoModal()` ‚Äî –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–∏—Å–µ
- `renderTrafficChart()` ‚Äî –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞
- `fetchNodesList()` ‚Äî –°–ø–∏—Å–æ–∫ –Ω–æ–¥

**EventSource –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
- `/api/events` ‚Äî –û–±—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `/api/events/services` ‚Äî –°–µ—Ä–≤–∏—Å—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

#### **theme_init.js**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è

**–§—É–Ω–∫—Ü–∏–∏:**
- –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ light/dark —Ä–µ–∂–∏–º–∞
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏

#### **common.js**
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã

**–§—É–Ω–∫—Ü–∏–∏:**
- `encrypt()/decrypt()` ‚Äî XOR —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- `animateModalOpen()/Close()` ‚Äî –ê–Ω–∏–º–∞—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
- `showNotification()` ‚Äî Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `formatBytes()` ‚Äî –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### SQLite Database Schema

#### Table: `nodes`
```sql
CREATE TABLE nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    token TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    ip TEXT,
    last_seen DATETIME,
    cpu_percent REAL DEFAULT 0.0,
    ram_percent REAL DEFAULT 0.0,
    disk_percent REAL DEFAULT 0.0,
    uptime INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### Table: `users`
```sql
CREATE TABLE users (
    telegram_id BIGINT PRIMARY KEY,
    role TEXT DEFAULT 'users',
    language TEXT DEFAULT 'en',
    username TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_seen DATETIME
);
```

### Encrypted JSON Configs

#### `config/users.json`
```json
{
    "12345678": {
        "role": "admins",
        "name": "John Doe",
        "lang": "en"
    }
}
```

#### `config/services.json`
```json
[
    "ssh",
    "docker",
    "nginx",
    "mysql",
    "postgresql"
]
```

#### `config/alerts_config.json`
```json
{
    "global_enabled": true,
    "thresholds": {
        "cpu": 80,
        "ram": 90,
        "disk": 85
    },
    "nodes": {
        "node_token_123": {
            "enabled": true,
            "custom_threshold": {...}
        }
    }
}
```

---

## üöÄ –†–µ–∂–∏–º—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏

### Root Mode
**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ
- –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `/proc` —Ö–æ—Å—Ç–∞ –≤ Docker
- –î–æ—Å—Ç—É–ø–Ω—ã –æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
‚úÖ –ß—Ç–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–æ–≥–æ–≤ (journalctl)
‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (apt upgrade)

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
bash deploy.sh
# –í—ã–±—Ä–∞—Ç—å: 3) Docker - Root Mode
```

### Secure Mode
**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞
- –ò–∑–æ–ª—è—Ü–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `tgbot` (UID 1000)

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –ª–æ–≥–∞–º
‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º
‚úÖ –í–µ–±-–ø–∞–Ω–µ–ª—å

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
bash deploy.sh
# –í—ã–±—Ä–∞—Ç—å: 1) Docker - Secure Mode (Recommended)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–£—Ä–æ–≤–Ω–∏:**
- `DEBUG` ‚Äî –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- `INFO` ‚Äî –û–±—ã—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- `WARNING` ‚Äî –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- `ERROR` ‚Äî –û—à–∏–±–∫–∏
- `CRITICAL` ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏

**–§–∞–π–ª—ã –ª–æ–≥–æ–≤:**
- `logs/bot/bot.log` ‚Äî –ì–ª–∞–≤–Ω—ã–π –ª–æ–≥ –±–æ—Ç–∞
- `logs/watchdog/watchdog.log` ‚Äî Watchdog —Å–æ–±—ã—Ç–∏—è
- `logs/node/node_{name}.log` ‚Äî –õ–æ–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã
- `logs/audit/audit.log` ‚Äî –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ü—Ä–æ—Å–º–æ—Ç—Ä –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:**
```bash
# Systemd
journalctl -u tg-bot -f

# Docker
docker compose -f /opt/tg-bot/docker-compose.yml logs -f bot-secure
```

### –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

**GET /api/health**
```json
{
    "status": "healthy",
    "version": "1.18.0",
    "uptime": 86400,
    "nodes_count": 5
}
```

**GET /api/debug/state** (—Ç–æ–ª—å–∫–æ –¥–ª—è Root)
```json
{
    "allowed_users": [...],
    "active_traffic_monitors": 3,
    "notifications_queue": 12,
    "memory_usage_mb": 145.2
}
```

---

## üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è

### –®–∞–±–ª–æ–Ω –º–æ–¥—É–ª—è

```python
# modules/my_feature.py

from aiogram import Dispatcher, types
from aiogram.types import KeyboardButton
from core.i18n import get_text as _
from core import config

BUTTON_KEY = "button_my_feature"
CATEGORY = "tools"  # monitoring/management/security/tools

def get_button() -> KeyboardButton:
    return KeyboardButton(text=_(BUTTON_KEY, config.DEFAULT_LANGUAGE))

def get_subcategory() -> str:
    return CATEGORY

def has_subcategory() -> bool:
    return True

def register_handlers(dp: Dispatcher):
    dp.message.register(
        my_feature_handler,
        lambda msg: msg.text == _(BUTTON_KEY, config.DEFAULT_LANGUAGE)
    )

async def my_feature_handler(message: types.Message):
    user_id = message.from_user.id
    # Your logic here
    await message.answer("Feature response")
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

1. **–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –≤ `core/i18n.py`:**
```python
STRINGS = {
    "button_my_feature": {
        "ru": "üéØ –ú–æ—è —Ñ–∏—á–∞",
        "en": "üéØ My Feature"
    }
}
```

2. **–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ `bot.py`:**
```python
from modules import my_feature

# –í main():
my_feature.register_handlers(dp)
```

3. **–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:**
```python
# core/config.py
KEYBOARD_CONFIG = {
    "my_feature": {"visible": True, "category": "tools"}
}
```

---

## üìö –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### Python Packages

**Core:**
- `aiogram==3.4.1` ‚Äî Telegram Bot API
- `aiohttp==3.9.1` ‚Äî Async HTTP —Å–µ—Ä–≤–µ—Ä
- `tortoise-orm==0.20.0` ‚Äî ORM –¥–ª—è SQLite
- `cryptography==41.0.7` ‚Äî Fernet —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- `argon2-cffi==23.1.0` ‚Äî –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

**Utilities:**
- `psutil==5.9.6` ‚Äî –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- `aiosqlite==0.19.0` ‚Äî Async SQLite
- `python-dotenv==1.0.0` ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ .env
- `jinja2==3.1.2` ‚Äî –®–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä HTML

**Optional:**
- `sentry-sdk==1.39.1` ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫
- `aerich==0.7.2` ‚Äî –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

**Dev:**
- `pytest==7.4.3`
- `black==23.12.1`
- `flake8==6.1.0`

### System –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ:**
- Ubuntu 20.04+ / Debian 11+
- Python 3.10+
- 1 GB RAM
- 10 GB Disk
- Docker 20.10+ (–¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ:**
- 2 GB RAM
- 20 GB SSD
- 2 CPU cores

---

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Aiogram Documentation](https://docs.aiogram.dev/)
- [Aiohttp Documentation](https://docs.aiohttp.org/)
- [Tortoise ORM](https://tortoise.github.io/)
- [Tailwind CSS](https://tailwindcss.com/)
- [Telegram Bot API](https://core.telegram.org/bots/api)

---

**–ê–≤—Ç–æ—Ä:** Jatix  
**–í–µ—Ä—Å–∏—è:** 1.18.0 (Build 66)  
**–õ–∏—Ü–µ–Ω–∑–∏—è:** GPL-3.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 27 —è–Ω–≤–∞—Ä—è 2026 –≥.
