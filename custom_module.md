# üß© –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –º–æ–¥—É–ª—è

–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ. –ö–∞–∂–¥—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `uptime`, `speedtest`) ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π Python-—Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ `modules/`. –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é, –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å 4 —à–∞–≥–∞.

### üìÇ –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –º–æ–¥—É–ª—è

–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `modules/`. –ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∑–æ–≤–µ–º –µ–≥–æ `my_feature.py`.

**–ü—É—Ç—å:** `/opt/tg-bot/modules/my_feature.py`

–í—Å—Ç–∞–≤—å—Ç–µ –≤ –Ω–µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–±–ª–æ–Ω –∫–æ–¥–∞. –≠—Ç–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —è–¥—Ä–æ–º –±–æ—Ç–∞.

```python
import asyncio
import logging
from aiogram import Dispatcher, types
from aiogram.types import KeyboardButton

# –ò–º–ø–æ—Ä—Ç—ã —è–¥—Ä–∞
from core.i18n import _, I18nFilter, get_user_lang
from core import config
from core.auth import is_allowed, send_access_denied_message
from core.messaging import delete_previous_message
from core.shared_state import LAST_MESSAGE_IDS

# 1. –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∫–Ω–æ–ø–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ i18n)
BUTTON_KEY = "btn_my_feature"

# 2. –§—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è –∫–Ω–æ–ø–∫—É –¥–ª—è –º–µ–Ω—é
def get_button() -> KeyboardButton:
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∫–Ω–æ–ø–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–∞ —è–∑—ã–∫–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    return KeyboardButton(text=_(BUTTON_KEY, config.DEFAULT_LANGUAGE))

# 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (Handlers)
def register_handlers(dp: Dispatcher):
    # –§–∏–ª—å—Ç—Ä I18nFilter –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ –ª—é–±–æ–º —è–∑—ã–∫–µ
    dp.message(I18nFilter(BUTTON_KEY))(my_feature_handler)

# 4. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –º–æ–¥—É–ª—è
async def my_feature_handler(message: types.Message):
    user_id = message.from_user.id
    chat_id = message.chat.id
    lang = get_user_lang(user_id) # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    command_name = "my_feature"   # –ò–º—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∏ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

    # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ ---
    if not is_allowed(user_id, command_name):
        await send_access_denied_message(message.bot, user_id, chat_id, command_name)
        return

    # --- –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞ ---
    # –£–¥–∞–ª—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å —á–∞—Ç
    await delete_previous_message(user_id, command_name, chat_id, message.bot)

    # --- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç..." ---
    await message.bot.send_chat_action(chat_id=chat_id, action="typing")

    # --- –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ ---
    # –ü—Ä–∏–º–µ—Ä: –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞–∫–æ–π-—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
    result_data = "–†–∞–±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç –±–µ—Ä–µ–º –∏–∑ i18n)
    response_text = _("my_feature_response", lang, data=result_data)

    # --- –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ ---
    sent_message = await message.answer(response_text, parse_mode="HTML")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –µ–≥–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—ã–∑–æ–≤–µ
    LAST_MESSAGE_IDS.setdefault(user_id, {})[command_name] = sent_message.message_id
```

-----

### üåê –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ (i18n)

–ß—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–Ω—è–ª—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –≤ —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤.

**–§–∞–π–ª:** `/opt/tg-bot/core/i18n.py`

–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–∞—Ä—å `STRINGS` –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –Ω–µ–≥–æ –≤–∞—à–∏ –∫–ª—é—á–∏ (`btn_my_feature`, `my_feature_response` –∏ —Ç.–¥.) –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ (`ru`) –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ (`en`) —è–∑—ã–∫–æ–≤.

```python
STRINGS = {
    'ru': {
        # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª—é—á–∏ ...
        "btn_my_feature": "‚ú® –ú–æ—è –§—É–Ω–∫—Ü–∏—è",
        "my_feature_response": "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏:\n<b>{data}</b>",
    },
    'en': {
        # ... existing keys ...
        "btn_my_feature": "‚ú® My Feature",
        "my_feature_response": "‚úÖ Feature result:\n<b>{data}</b>",
    }
}
```

-----

### ‚öôÔ∏è –®–∞–≥ 3: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è –≤ –±–æ—Ç–µ

–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ —Å–æ–æ–±—â–∏—Ç—å –≥–ª–∞–≤–Ω–æ–º—É —Ñ–∞–π–ª—É –±–æ—Ç–∞ –æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è.

**–§–∞–π–ª:** `/opt/tg-bot/bot.py`

1.  **–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –º–æ–¥—É–ª—å** –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞:

    ```python
    from modules import (
        selftest, traffic, uptime, ...,
        my_feature  # <-- –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à –º–æ–¥—É–ª—å —Å—é–¥–∞
    )
    ```

2.  **–í–∫–ª—é—á–∏—Ç–µ —Ñ–ª–∞–≥** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è):

    ```python
    ENABLE_MY_FEATURE = True
    ```

3.  **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –º–æ–¥—É–ª—å** –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `load_modules()`:

    ```python
    def load_modules():
        # ... –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ ...

        if ENABLE_MY_FEATURE:
            # –û–±—ã—á–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–¥–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–∑ whitelist)
            register_module(my_feature)

            # –ò–õ–ò —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤:
            # register_module(my_feature, admin_only=True)

            # –ò–õ–ò —Ç–æ–ª—å–∫–æ –¥–ª—è Root (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ):
            # register_module(my_feature, root_only=True)
    ```

-----

### üîÑ –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫

–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Systemd:**

```bash
sudo systemctl restart tg-bot
```

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker:**

```bash
docker compose restart bot-secure
# –∏–ª–∏
docker compose restart bot-root
```

### ‚úÖ –ì–æ—Ç–æ–≤–æ\!

–¢–µ–ø–µ—Ä—å –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é –±–æ—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ **"‚ú® –ú–æ—è –§—É–Ω–∫—Ü–∏—è"**. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –Ω–µ—ë –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∫–æ–¥ –∏–∑ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞ `my_feature.py`.
