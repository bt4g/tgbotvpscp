name: "Safe Refactor and Cleanup"

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  refactor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          pip install black isort pytest pytest-asyncio

      - name: Run Tests (Pre-check)
        run: |
          mkdir -p tests
          pytest || echo "Warning: Initial tests failed or no tests found"

      - name: Import Sort (Isort)
        run: isort .

      - name: Code Format (Black)
        run: black .

      - name: Remove Comments
        run: |
          python .github/scripts/clean_code.py

      - name: Code Format Again
        run: |
          black .

      - name: Run Tests (Post-check)
        run: |
          pytest

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Refactor: remove comments, format code"
          title: "Auto-Refactor: Cleanup and Format"
          body: |
            This PR was automatically created by GitHub Actions.
            
            Changes:
            - Removed comments and docstrings
            - Formatted code with black
            - Sorted imports with isort
            - Verified with pytest
          branch: "refactor/auto-cleanup"
          delete-branch: true
          base: "feature/1.15.3"